<!-- This file was generated by mk_html_help.pro -->
<html>
 
<head>
<TITLE>GENIE - GENSPEC</TITLE>
</head>
 
<body>
<H1>GENIE - GENSPEC</H1>
<P>
This page was created by the IDL library routine 
<CODE>mk_html_help</CODE>.  For more information on 
this routine, refer to the IDL Online Help Navigator 
or type: <P>
<PRE>     ? mk_html_help</PRE><P>
at the IDL command line prompt.<P>
<STRONG>Last modified: </STRONG>Fri Jun  8 16:27:54 2012.<P>
 
<HR>
 
<A NAME="ROUTINELIST">
<H1>List of Routines</H1></A>
<UL>
<LI><A HREF="#GENSPEC_GPV2SPECTRA">GENSPEC_GPV2SPECTRA</A>
<LI><A HREF="#GENSPEC_GPV2VOXEL_VEL_MATRIX">GENSPEC_GPV2VOXEL_VEL_MATRIX</A>
<LI><A HREF="#GENSPEC_INVERT_MOMENTS">GENSPEC_INVERT_MOMENTS</A>
<LI><A HREF="#GENSPEC_LI_MOMENTS">GENSPEC_LI_MOMENTS</A>
<LI><A HREF="#GENSPEC_MATRIX_INVERT">GENSPEC_MATRIX_INVERT</A>
<LI><A HREF="#GENSPEC_MOMENTS">GENSPEC_MOMENTS</A>
<LI><A HREF="#GENSPEC_MOMENT_RANGE">GENSPEC_MOMENT_RANGE</A>
<LI><A HREF="#GENSPEC_POS2VOXEL_VEL_MATRIX">GENSPEC_POS2VOXEL_VEL_MATRIX</A>
<LI><A HREF="#GENSPEC_ROCKING_MAP">GENSPEC_ROCKING_MAP</A>
<LI><A HREF="#GENSPEC_SHELLINVERT">GENSPEC_SHELLINVERT</A>
<LI><A HREF="#GENSPEC_SPHERE_IMAGE">GENSPEC_SPHERE_IMAGE</A>
<LI><A HREF="#GENSPEC_SPHERE_OBSEMISS">GENSPEC_SPHERE_OBSEMISS</A>
<LI><A HREF="#GENSPEC_SUB_VECTOR">GENSPEC_SUB_VECTOR</A>
<LI><A HREF="#GENSPEC_VEL_COEF_MATRIX">GENSPEC_VEL_COEF_MATRIX</A>
<LI><A HREF="#XCIS_LINESHAPE">XCIS_LINESHAPE</A>
<LI><A HREF="#_GENSPEC">_GENSPEC</A>
</UL><P>
 
<HR>
 
<H1>Routine Descriptions</H1>
<A NAME="GENSPEC_GPV2SPECTRA">
<H2>GENSPEC_GPV2SPECTRA</H2></A>
<A HREF="#GENSPEC_GPV2VOXEL_VEL_MATRIX">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_GPV2SPECTRA

PURPOSE:
	This function takes a view described by a GPV and LHAT from GENPOS_VOL_COEFS and forms the line integrated spectral power.  
	The Doppler broadened/shifted spectral emissivity at anypoint in the plasma is formed by assuming input Ti, vel 
	and total emissivity profiles are flux functions.

CALLING SEQUENCE:
	result=GENSPEC_GPV2SPECTRA(gridpts,gpv,lhat,emiss,ti,vel,line,shot)

INPUTS:
	gridpts:	STRUC of points describing the grid.  This is a GENPOS_GRID output using /center
	gpv: 		STRUC containing gpv for each upos for each detector only for non-zero elements
			*.d0	gpv and spatial information for detector 0
				*.tmp	LONARR 	[#non_zero] of array elements (gridpts.pnts[*,gpv.tmp])
				*.gpv	FLTARR 	[#non_zero,l] of gpv values [1/m^3]
			*.d1	gpv and spatial information for detector 1
			  .			 .
			  .			
			*.dn	gpv and spatial information for detector n
	lhat: 		STRUC containing lhat structures for each UPOS for each detector only for non-zero elements
			*.d0	lhat and spatial information for detector 0	
				*.tmp	LONARR 	[#non_zero] of array elements (gridpts.pnts[*,gpv.tmp])
				*.lhat	STRUC	of lhat data at each point in *.tmp
					*.lr	STRUC of unit vectors in the radial (major radius) direction (in and out)
						*.in	FLTARR [#non_zero] of the average radial unit vector going in
						*.dvin	FLTARR [#non_zero] of the volume weightings going in
						*.out	FLTARR [#non_zero] of the average radial unit vector coming out
						*.dvout	FLTARR [#non_zero] of the volume weightings coming out
					*.lphi 	FLTARR [#non_zero] average unit vector in the polar angle (toroidal) direction
					*.lz	FLTARR [#non_zero] average unit vector in the vertical (vertical) direction
	emiss:		STRUC containing the line emissivity and its spatial/temporal information
			*.emiss	FLTARR [#r,#lines,#t] of the line emissivity [X/vol] (see MIST_ZZ_PROFILES)
			*.r	FLTARR of the midplane major radii of emiss
			*.t	FLTARR of the time points (can be a single point if *.emiss is 1D array)
	ti:		STRUC containing the ion temperature and its spatial/temporal information
			*.ti	FLTARR [#r,#t] of the ion temperature [keV] to be used in broadening calcs
			*.r	FLTARR of the midplane major radii of ti
			*.t	FLTARR of the time points (can be a single point if *.ti is 1D array)
	vel:		STRUC containing the velocity and its spatial/temporal information
			*.u	FLTARR [#r,#t] of the u function in incompressibility [m/s/T]
			*.w	FLTARR [#r,#t] of the w function in incompressibility [1/s]
			*.r	FLTARR of the midplane major radii of vel
			*.t	FLTARR of the time points (can be a single point if *.vel is 1D array)	
	line:		STRUC containing information about the line to be calculated
			*.lam_o		FLTARR [#lines] the rest wavelength of the line [units set wavelength scale]
			*.del_lam	FLT used in the  wavelength interval [min(lam_o)-del_lam, max(lam_o)+del_lam]
			*.mass		FLT the mass of ion in AMU (see READ_ATOMIC_MASS('XX')
	shot:		LONINT shot number

OPTIONAL INPUTS:
	gpv:		FLATRR of the gpv value at each (R,Z) from					***/NORAW FORMAT***
	lhat:		STRUC of the average unit vectors in (r,phi,z)					***/NORAW FORMAT***
			*.lr	STRUC sub structure for the radial unit vector data		
				*.in	FLTARR [n, m] of the average radial unit vector going in
				*.dvin	FLTARR [n, m] of the volume weightings going in
				*.out	FLTARR [n, m] of the average radial unit vector coming out
				*.dvout	FLTARR [n, m] of the volume weightings coming out
			*.lphi	FLTARR [n, m] of the average toroidal unit vector
			*.lz	FLTARR [n, m] of the average vertical unit vector

	t_pts:		FLTARR of length t time points for which output data is calculated DEFAULT: emiss.t
	n_lam:		INT the number of spectral bins DEFAULT: 100
	grid2rmid:	FLTARR of the output of GENPOS_GRID2RMID(gridpts, shot, tpts=t_pts).  This can be input to save
				time if running GENPOS_GPV2SPECTRA for multiple detectors
	missing:	FLT value emiss,ti and vel for points outside the LCFS DEFAULT: 1.0e-4 (non-zero because of division error)
	interp:		STRUC of ti, emiss and vel interpolated points.  Again, this data would be the same for multiple
				detectors.  See OPTIONAL OUTPUTS.

KEYWORD PARAMETERS:
	debug:		/debug stops the code before the RETURN statement
	noraw:		/noraw will process the gpv and lhat inputs assuming not "raw" format to increase speed.

OUTPUTS:
	result:		STRUC of line integrated spectral brightness
			*.plam 		FLTARR of size n_lam x t that is the total line integrated spectral power summed over all upos
						at the time points given by t_pts.  Units are of [emiss]*[raw_gpv]/[lam_o] such as W/nm 
			*.lam 		FLTARR of length n_lam that is the wavelength scaling 

			Error infromation is encoded in the output if GENPOS_GPV2SPECTRA fails.
			result 	= -1	error in Ti interpolation (usually demand a time point out of bounds of the inputs)
				= -2	error in emissivity interpolation 
				= -3	error in velocity interpolations 	

OPTIONAL OUTPUTS
	interp:		STRUC of the ti, emiss and vel data at each of the (R,Z) locations on the plasma grid.  If this struc is not
				input then these will be calculated from the ti, emiss, vel inputs.  
				*.ti 	FLTARR of size n x t of Ti on each pixel point in ves_grid for each time point in t_pts
				*.em 	FLTARR of size n x t of emissivity
				*.u	FLTARR of size n x t of the u function in the velocity equation
				*.w	FLTARR of size n x t of the u function in the velocity equation				
	gpvspec:	FLTARR of size n x n_lam x t of the spectral emissivity for each plasma pixel as seen by the detector
				described by upos.

PROCEDURE:
	The depencedy of the spectral emissivity on line of sight due to Doppler shift, delta=dot(v,l_hat), prevents the
	spectral emissivity to be expanded onto a grid for general usage like GRID_PROFILE does for the total emissivity.  Instead, the
	spectral power (W/nm or photons/s/nm for example) deposited on the detector must be calculated by using information for each
	sub-pixel in upos before being summed.  This is why the raw output of GENPOS_VOL_COEFS must be input.  The equations
	are listed in 'General Equations for Radiometery in Tokamak Plasmas' and more discussion is presented.

	The emiss,ti,vel and line input STRUC can be easily generated using MIST_GENPOS_INPUT_DATA.  If this function is called
	multiple times, it should be run first to fill the optional outputs of grid2rmid and interp.  These can then be put
	back into subsequent calls for a large speed increase.

	After 6-05-07, the way GENPOS_GPV2SPECTRA calculates the doppler shift has been changed.  Now the incompressible
	velocity relation v = u*B + w*R is used.  See section XX in 'General Equations for Radiometery in Tokamak Plasmas' for more discussion

MODIFICATION HISTORY:
	Written by:	ML Reinke - 8-12-06
	8-18-06:	ML Reinke - overhauled the loop to fill the data to increase the speed (about x10 increase).  I also noticed
				that the profile interpolations will not work correctly if more than one time point is called.  Since
				this program is linked with MIST its not a concern right now.
	8-20-06:	ML Reinke - fixed the time dependency of the profile interpolations and added the missing optional input
	8-21-06:	ML Reinke - renamed to GENSPEC_GPV2SPECTRA
	6-05-07:	ML Reinke - reformatted the velocity input structure and the spectra calculation to use u and w from
                                   incompressibility equation (see procedure)
	8-14-07:	ML Reinke - overhauled the code to use the new format of raw GPV and LHAT from GENPOS_VOL_COEFS.  Changed input upos to lhat.
	8-15-07:	ML Reinke - allowed code to accept emiss and line structures that include inputs for multiple lines.  
	8-15-07:	ML Reinke - allowed code to accept GPV and LHAT data for a single view that is not raw (keyword noraw)
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_GPV2VOXEL_VEL_MATRIX">
<H2>GENSPEC_GPV2VOXEL_VEL_MATRIX</H2></A>
<A HREF="#GENSPEC_GPV2SPECTRA">[Previous Routine]</A>
<A HREF="#GENSPEC_INVERT_MOMENTS">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_GPV2VOXEL_VEL_MATRIX

PURPOSE
	This function will take a set of GPVs, the rho values of their locations,the pos vector, ves_cent and bfield  and
	turn it into a weighting matrix for velocity weighted emissivity profile inversion.

CALLING SEQUENCE
	result=GENSPEC_GPV2VOXEL_VEL_MATRIX(gpv, rhopts,pos,ves_cent,bfield)

INPUTS:
	gpv		FLTARR [n_ch, n_pts] of the volume weightings generated using GENPOS_VOL_COEFS
	rhophts		FLTARR [n_pts,n_time] of the rho locations of the (R,Z) points that locate each GPV at each time point
	pos:		FLTARR 	4 x n of the central (or weighted) POS vector for each channel.
	ves_cent:	STRUC	the vessel grid generated from GENPOS_GRID or GRID_VES using /center
	bfield:		STRUC   of data describing the magnetic field on the grid (See GENPOS_GRID_BFIELD for method)
			*.br		FLTARR [n_pts] radial component of the magnetic field [T]
			*.bphi 		FLTARR [n_pts] toroidal component of the magnetic field [T]
			*.bz		FLTARR [n_pts] veritical component of the magnetic field [T]
			
			****BFIELD NOT BEING USED YET****

OPTIONAL INPUTS:
	n_rho:		INT number of points from 0.0 -> 1.0 (inclusive) for the 
	rho_vec:	FLTARR [n_rho] of the rho points that each column of the result
	posrev:		INTARR [n_ch] of 0's and 1's to indicate for each pos to reverse or not in GENPOS_LHAT

KEYWORD PARAMETERS:
	solidbody:	/solidbody forces a matrix to be generated that will be used to find w profile (just toroidal rotation DEFAULT)
	diff:		/diff is passed to GENPOS_LHAT

OUTPUTS
	result:		FLTARR [n_ch, n_rho, n_time] of the voxel weightings for each channel at each rho to be used in profile inversion

OPTIONAL OUTPUTS:
	rho_vec:	FLTARR if set to an unnamed variable it will be filled with the rho.

MODIFIATION HISTORY:
	Written by:	ML Reinke 6/11/07 - only allowing toroidal rotation
	7-12-07:	ML Reinke - fixed a WHERE bug that would crash if no weighting in the plasma was foun
       7-17-07:	ML Reinke - allowed 2D rhopts so that multiple time slices can be calculated
	7-19-07:	ML Reinke - moved into GENSPEC.PRO changed name from GENPOS_*** to GENSPEC_***
	2-18-08:	ML Reinke - updated the u and w voxel matrices to interpolate between rho points
                                   instead of locking to nearest one.
	2-18-08:	ML Reinke - added posrev optional input and diff keyword parameter to be used with GENPOS_LHAT
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_INVERT_MOMENTS">
<H2>GENSPEC_INVERT_MOMENTS</H2></A>
<A HREF="#GENSPEC_GPV2VOXEL_VEL_MATRIX">[Previous Routine]</A>
<A HREF="#GENSPEC_LI_MOMENTS">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_INVERT_MOMENTS

PURPOSE:
	This is a higer level function that calls other GENPOS and GENSPEC functions to create matrices and then 
	does a least squares inversion on each moment vector to find the coefficents of expansion for the line emissivity,
	velocity and ion temperature profiles.

CALLING SEQUENCE:
	result=GENSPEC_INVERT_MOMENTS(m0,m1,m2,gpv,pos,bfield,line,ves_grid,rhopts,order)

INPUTS:
	m0:		FLTARR 	of length n, where n is the number of channels, of the zeroth moment of the spectra     ]
	m1:		FLTARR 	of length n of the first moment								](see GENSPEC_MOMENTS)
	m2:		FLTARR 	of lenght n of the second moment							]
	gpv:		FLTARR	n x m  where m is the number of pixels.  These are the volume coefficents
				generated using GENPOS_VOL_COEFS [meters^3]
	pos:		FLTARR 	4 x n of the central (or weighted) POS vector for each channels.
	bfield:		STRUC   of data describing the magnetic field on the grid (See GENPOS_GRID_BFIELD for method)
			*.br		FLTARR [n_grid, n_time] radial component of the magnetic field [T]
			*.bphi 		FLTARR [n_grid, n_time] toroidal component of the magnetic field [T]
			*.bz		FLTARR [n_grid, n_time] veritical component of the magnetic field [T]
			*.psi_norm	FLTARR [n_grid, n_time] normalized psi values ***not used***
			*.t_pts		FLTARR [n_time] time points [s] ***not used***
			*.shot		LONG shot number ***not used***
	line:		STRUC 	containing information about the line to be calculated
			*.lam_o		FLT the rest wavelength of the line [units set wavelength scale]        
			*.del_lam	FLT used in the  wavelength interval [lam_o-del_lam, lam_o+del_lam]    ***not used***
			*.mass		FLT the mass of ion in AMU (see READ_ATOMIC_MASS('XX')
	rhopts:		FLTARR	m x t where t is the number of time points.  These are normalized radius (rho) values that correspond 
				to the m pixels and should be generated using GENPOS_GRID2RMID.
	ves_grid:	STRUC	the vessel grid generated from GENPOS_GRID using /center

KEYWORD PARAMETERS:
	solidbody:	/solidbody will generate a sub vector and velocity coef matrix using only w(rho) which is pure toroidal rotation

OUTPUTS:
	result:		STRUC of the least squares fit of the profile coefficients to the moments;
				*.c0	FLTARR of length order[0] for the total emissivity profile coeffcients
				*.c1	FLTARR of length 2*order[1] for the emissivity weighted "velocity" profile coeffcients
					c1[0:order[1]-1] are the em(rho)*w(rho) coefs
					c1[order[1]:2*order[1]-1] are the em(rho)*u(rho) coefs (if /solidbody not set)
				*.c2	FLTARR of length order[2] for the emissivity weighted temperature profile coefficients

PROCEDUE:
	The matrix equation Ax=b is solved where x are the expansion coefficents, b are the moments (see GENSPEC_MOMENTS) 
	and A is necessary geometry information.  This is solved using x=LA_INVERT(transpose(A)#A,/double)#transpos(A)#b 
	which is the least squares inversion.
	
	More detailed equations can be found (in the near future) in 'General Equations for Radiometry in Tokamak Plasmas'.

RESTRICTIONS
	This function calls GENPOS_GPV2COEF_MATRIX, GENSPEC_VEL_COEF_MATRIX and GENSPEC_SUB_VECTOR to calculate the
	necessary matrices.  All inversions are done using LA_INVERT.

MODIFICATION HISTORY:
	Written by:	ML Reinke: 8-21-06
	6-7-07:		ML Reinke: added solidbody optional input to carry thru to GENPSPEC_VEL_COEF_MATRIX and GENSPEC_SUB_VECTOR
				   added the bfield input for use in these function and updated help file
	6-8-07:		ML Reinke: fixed a bug that prevented the 2nd moment from having a different order than the 0th moment
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_LI_MOMENTS">
<H2>GENSPEC_LI_MOMENTS</H2></A>
<A HREF="#GENSPEC_INVERT_MOMENTS">[Previous Routine]</A>
<A HREF="#GENSPEC_MATRIX_INVERT">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_LI_MOMENTS

PURPOSE:
	This function generates the spectral moments used in GENSPEC inversion from sets of (lambda, intensity)
	pairs instead of ordered data like GENSPEC_MOMENTS needs.

CALLING SEQUENCE
	result=GENSPEC_LI_MOMENTS(lam,int,lam_o)	

INPUTS:
	lam:	FLTARR [n_pts,n_ch,n_time] of the wavelength values [in lam_o units] for each channel at each time
			OPTIONALLY you can make lam a FLTARR [n_pts]
	int:	FLTARR [n_pts,n_ch,n_time] of the intensity values [photons/lam] at those wavelength values
	lam_o	FLT	of the unshifted wavelength of the line

OPTIONAL INPUTS:
	lr:	FLTARR [2] (lam_low, lam_high) of the inclusive wavelength region to truncate dataset.  See
		GENSPEC_MOMENT_RANGE for generating values of this number.
	ikplot:	FLTARR [2] of the (i,k) (ch, time) point that you only want to plot.  Still use /plot to invoke.

KEYWORD PARAMETERS:
	backsub:	/backsub will use the first two and last two lambda points to form an average for background subtraction
	debug:		/debug stops the code before the return statement
	plot:		/plot will plot int vs lam for each time point for each channel
	sort:		/sort invokes /sort in INT_TABULATED
	double:		/double invokes /double in INT_TABULATED
	
OUTPUTS:
	result:	FLTARR 	[3, n_ch, n_time] of the spectral moments
			[0, *, *] is the zeroth moment [photons]
			[1, *, *] is the first moment  "wavelength*counts" [angstroms*photons]  consistent units with lam_o
			[2, *, *] is the second moment  "wavelength^2*counts" [angstroms^2*photons]  consistent units with lam_o

OPTIONAL OUTPUTS:
	err:	FLTARR  [3, n_ch, n_time] of statisical uncertainty (sigma)
			[0, *, *] is the zeroth moment error
			[1, *, *] is the first moment error
			[2, *, *] is the second moment error

PROCEDURE
	This function uses INT_TABULATED to form the numerical integral.  Thus values of lam can be irregularly gridded and even in a
	random order (use /sort then) but they must be unqiue.
	
	Use GENSPEC_MOMENT_RANGE to inform the decesion of an lr interval.  This will help to reduce photon and background subtraction noise
	from affecting the first and second moment values.

MODIFICATION HISTORY;
	Written by: 	ML Reinke - 7/19/07
       8-22-07:	ML Reinke - modified so that lam could be a 1D as well as 3D
       10-30-08:	ML Reinke - added the optional output err, the statistical errors of the moment profiles
	12-11-08	ML Reinke - made the moments error absolute value since when doing background subtraction negative brightness
                                   can result.  Need to modify to include bsub error

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_MATRIX_INVERT">
<H2>GENSPEC_MATRIX_INVERT</H2></A>
<A HREF="#GENSPEC_LI_MOMENTS">[Previous Routine]</A>
<A HREF="#GENSPEC_MOMENTS">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_MATRIX_INVERT

PURPOSE;
	This is an upper level function that takes spectral moments and geometry weighting information and calculates
	emissivity, velocity and ion temperatures for a given impurity.  Some might call this Unleashing The Fury (TM) 
	but I feel that's being a bit melodramatic.

CALLING SEQUENCE:
	result=GENSPEC_MATRIX_INVERT(moments,gpv,pos,shot,time,ves_cent,lam_o,z)

INPUTS:
	moments:	FLTARR 	[3, n_ch, n_time] of the spectral moments
			       	[0, *, *] is the zeroth moment [photons/s] or other "power" unit
			       	[1, *, *] is the first moment  [angstroms*photons/s]  consistent units with lam_o
			       	[2, *, *] is the first moment  [angstroms^2*photons/s]  consistent units with lam_o
	gpv:		FLTARR 	[n_ch, n_grid] of the GENPOS volume coefficients for each channel.  See GENPOS_VOL_COEFS
	pos:		FLTARR 	[4,n_ch] of the average POS vectors for each channel.  Used to calculate projection of Doppler shift
	shot:		LONG 	shot number
	time:		FLTARR 	[n_time] of the time points.  Note that all geometry info will be calculated at EFIT time points
			       	so either run EFIT at your time points or calculate the moments at EFIT time points for most accurate
			       	results
	ves_cent:	STRUCT 	the vessel grid structure generated from GENPOS_GRID or GRID_VES using /center, consistent with gpv
	lam_o:		FLT	the unshifted wavelength of the line.  Units consistent with how the moments are calculated.
	z:		INT	the z of the element that's being observed

OPTIONAL INPUTS:
	good:		INTARR	[n_ch] with 1's (use) or 0's (do not use) indicating which channels to use during the inversion
	rhopts:		FLTARR	[n_grid, n_time] of the rho values corresponding to the (R,Z) grid points.  This will be calculated
				by GENSPEC_MATRIX_INVERT but is an optional output that can be reused on different spectral lines to
				save computation time.
	bfield:		STRUC	see GENPOS_GRID_BFIELD for structure but like rhopts this needs only be calculated once per shot
				and can be taken as an optional output and used in later inversions for different lines.
	n_rho:		INT	number of points from minimum < rho < 1.0 (inclusive) to be used in inversion DEFAULT: 25
	rho_vec:	FLTARR 	the actually rho points to be used DEFAULT: not used
	u_rho_lim:	FLTARR  of the rho value below which the u-profile is forced to zero (helps convergance)  DEFAULT: 0.35
	eta:		FLT	edge zero weighting factor DEFAULT: 0.0
	eps_em:		FLT	emissivity profile smoothing factor. DEFAULT: 1.0
	eps_w:		FLT	toroidal rotation profile smoothing factor. DEFAULT: 1.0
	eps_u:		FLT	field aligned rotation profile smoothing factor. DEFAULT: 1.0
	eps_ti:		FLT	ion temperature profile smoothing factor. DEFAULT: 1.0
	n_iter:		INT 	number of iterations (if finding u-profile) to perform to find u from first moment residual DEFAULT: 50
	posrev:		INTARR	[n_ch] of 0's and 1's for reversing the pos in GENPOS_LHAT through GENSPEC_GPV2VOXEL_VEL_MATRIX
	err:		FLTARR	[3,n_ch,n_time] of the error in the moment profiles.  Use output from GENSPEC_LI_MOMENTS
	n_err_inv:	INT	number of inversion to complete to calculate error.  DEFAULT set in GENPOS_PROFILE_INVERT

KEYWORD PARAMETERS:
	solidbody:	/solidbody does the first moment inversion forcing the u-profile = 0
	parallel:	/parallel does the first moment inversion forcing the w-profile = 0 [NOT TESTED YET]
	nofirst:	/nofirst prevents the matrix inversion from weighting the profile so that it has zero derivative at rho=0
	debug:		/debug stops the code in various places and just before the RETURN statement
	quiet:		/quiet suppresses terminal messages displaying computation times of various procedures
	diff:		/diff is passed onto GENPOS_LHAT through GENSPEC_GPV2VOXEL_VEL_MATRIX

OUTPUTS:
	result:		STRUC	containing the kinetic profiles and their moment profile checks
			*.rho		FLTARR 	[n_rho] of the rho values at which each profile has been calculated
			*.time		FLTARR 	[n_time] of the time points (copy of time input for convience)
			*.emiss 	FLTARR 	[n_rho, n_time] of the line emissivities [photons/s/m^3] or "power"/m^3
			*.w		FLTARR	[n_rho, n_time] of the "w/2pi"-profile or toroidal rotation frequency [Hz]
			*.u		FLTARR  [n_rho, n_time] of the u-profile [m/s/T]
			*.ti		FLTARR  [n_rho, n_time] of the impurity ion temperature [keV]
			*.ch		INTARR 	[n_ch] of only the GOOD channels used in the inversion
			*.brchk		FLTARR 	[3, n_ch, n_time] of the moments calculated from the calculated profiles.  This can be
						be used to check the quality of the output versus the input data.
			*.inverr	FLTARR	[3,n_rho,n_time] of the absolute inversion error in the kinetic profiles.  Will 
						be zeros if optional input err is not specified.  Units for each are in the same as above.

OPTIONAL OUTPUTS:
	rhopts:		FLTARR [n_grid, n_time] the output of GENPOS_GRID2RMID(ves_cent,shot,tpts=time,/rho) for future use
	bfield:		STRUC the output of GENPOS_GRID_BFIELD(ves_cent,shot,t_pts=time) for future use
	moment1_conv	FLTARR [n_iter, n_time] showing the convergence of the STDEV of the first moment residual over the
				mean of the first moment * 100

PROCEDURE:
	This program calculates the spatial weighting matrices using GENPOS_GPV2VOXEL_MATRIX and GENPOS_GPV2VOXEL_VEL_MATRIX and then
	inverts them using GENPOS_PROFILE_INVERT.  The eps values for each inversion, at each time point are weighted to the max value of
	the voxel matrix.  For example, the GENPOS_PROFILE_INVERT eps input for the emissivity profile, at each time point i is: 
		
		double(eps_em*(max(voxel[*,*,i]))^2)

	To determine the u-profile and w-profile from the same data set, the assumption is made that it is small compared to the w-profile.
	The inversion is done assuming all of moment[1,*,i] is due to the w-profile.  Then the residual is found from brchk and the u-profile is
	determined from this residual.  This brchk is subtracted from  moment[1,*,i] and new w-profile is calculated.  This
	process is iterated n_iter number of times.  This type of analysis assumes that your GPV/POS are setup such that you can distinguish
	the solidbody and parallel parts (ie a full ~poloidal cross section like HIREX-SR).

RESTRICTIONS:
	Use GENIE_INI.bat to compile the GENPOS and GENSPEC functions in the correct order.  You should know what you're doing before
	using this function.  It's the third rail of spectroscopy.

MODFICATION HISTORY:
	Written by:	ML Reinke - 7/18/07
	7/23/07:	ML Reinke - changed default n_rho to 25 from n_ch
	8/02/07:	ML Reinke - added the nofirst keyword and  made the function calculate the
				    minimum rho and use as optional input in GENPOS_GPV2VOXEL_MATRIX
	8/03/07:	ML Reinke - fixed a bug that was performing the sub_vector operation incorrectly.  Now 
				    GENSPEC_MATRIX_SUB_VECTOR is called at each time interval.
	8/03/07:	ML Reinke - updated to be able to calculate a u-profile using an iterative method on the first moment residual
				    added keywords: solidbody and parallel, optional inputs: eps_u, u_rho_lim and n_iter,
				    outputs: *.u, optional output: moment1_conv
	8/15/07:	ML Reinke - added the eta optional input for edge zero
	2/01/08:	ML Reinke - fixed voxel indexing bugs in the Ti profile that caused time range dependant profiles effects.
	2/12/08:	ML Reinke - fixed indexing bug for the u profile brightness check.
	2/18/08:	ML Reinke - added diff and posrev for GENPOS_LHAT called in GENSPEC_GPV2VOXEL_VEL_MATRIX
	10/29/08:	ML Reinke - added the iterate keyword to switch between methods for velocity inverstion
	10/30/08:	ML Reinke - added the err,n_err_inv optional inputs for calculating the inversion error profiles
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_MOMENTS">
<H2>GENSPEC_MOMENTS</H2></A>
<A HREF="#GENSPEC_MATRIX_INVERT">[Previous Routine]</A>
<A HREF="#GENSPEC_MOMENT_RANGE">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_MOMENTS

PURPOSE:
	This function forms the zeroth, first and second moment vectors from an array of spectra.  This data is
	needed as an input to GENPOS_INVERT_MOMENTS.

CALLING SEQUENCE:
	result=GENSPEC_MOMENTS(spec,lam,lam_o)

INPUTS:
	spec:	FLTARR of size n_lam x n_ch x n_time of the spectra units [X/[lam_o units] - like ph/s/ang or mW/ang]
	lam:	FLTARR of length n_lam that is the wavelength scale for spec.  If the wavelength scale is different for
			different channels then lam can be input as a n_lam x n_ch array.
	lam_o:	FLT of the rest wavelength of the line.
	
KEYWORD PARMAETERS:
	debug:		/debug stops the codes before the RETURN statement

OUTPUTS:
	result:	FLTARR of size 3 x n_ch,n_time where [i,*,k] is the ith-moment for all the channels at the kth time point
		The units are those of X, X*lam_o and X*lam_o^2 for each moment.

		An output of result = -1 indicate that the lam input is improperly formatted compared to spec
PROCEDURE:
	The moments are formulated using INT_TABULATED in the following manner (j-det k-time):
		mom_i=int_tabulated(lam,spec[*,j,k]*(lam-lam_o)^i)

MODIFICATION HISTORY:
	Written by:	ML Reinke: 8-21-06

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_MOMENT_RANGE">
<H2>GENSPEC_MOMENT_RANGE</H2></A>
<A HREF="#GENSPEC_MOMENTS">[Previous Routine]</A>
<A HREF="#GENSPEC_POS2VOXEL_VEL_MATRIX">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_MOMENT_RANGE
	
PURPOSE:
	This procedure is used to help find the best wavelength interval over which to perform the GENSPEC_LI_MOMENTS.
	The moments

CALLING SEQUENCE:
	GENSPEC_MOMENT_RANGE,lam,int,lam_o,i_time

INPUTS:
	lam:	FLTARR [n_pts,n_ch,n_time] of the wavelength values [in lam_o units] for each channel at each time
			Can also be [n_pts] too.
	int:	FLTARR [n_pts,n_ch,n_time] of the intensity values [arbitrary "power" units] at those wavelength values
	lam_o	FLT	of the unshifted wavelength of the line
	i_time:	INT	of the point in n_time for which this procedure should be run

KEYWORD PARAMETERS:
	bsub		/bsub sends /backsub to GENSPEC_LI_MOMENTS

OPTIONAL INPUTS:
	n_r:	INT	number of points to for which to plot spectra
	low	FLT	lam_o-low
	up:	FLT	lam_o+up

OUTPUTS:
	Outputs are graphical to the currently selected plotting device.

MODIFICATION HISTORY:
	Written by:	ML Reinke - 7/19/07
	3/6/08:		ML Reinke - added a bsub keyword and allowed lam to be 1D
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec_utility.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_POS2VOXEL_VEL_MATRIX">
<H2>GENSPEC_POS2VOXEL_VEL_MATRIX</H2></A>
<A HREF="#GENSPEC_MOMENT_RANGE">[Previous Routine]</A>
<A HREF="#GENSPEC_ROCKING_MAP">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_POS2VOXEL_VEL_MATRIX

PURPOSE:
	This function creates a velocity voxel matrix using a pos vector and an etendue vector using an EFIT reconstruction

CALLING SEQUENCE:
	result=genspec_pos2voxel_matrix(pos,u,shot)

INPUTS:
	pos:		FLTARR	[4,n_ch] of the [Ro,Zo,Rt,Psi] for each channel 
	u		FLTARR	[n_ch] of the etendue for each channel [m^2-str]
	shot:		LONG	of the shot number for EFIT reference

OPTIONAL INPUTS:
	tpts:		FLTARR	of the time points to calculate the voxel matrix DEFAULT = all EFIT times
	n_s:		INT	number of points along line of sight to divide view into DEFAULT: 300
	rzbnd		FLTARR 	[r_min,r_max,|z|] of the rectangular bounding box for the lines DEFAULT: [0.44,1.0,0.45]
	rho_min		FLT	minimum value of rho to be used DEFAULT: 0.0
	n_rho		INT	number of rho points to use DEFAULT: 20
	rho_vec		FLTARR	of the rho points for which the voxel matrix is created: DEFAULT: make(rho_min,1.0,n_rho)
	rz_ap		FLTARR  [R_ap, Z_ap] of the aperature to start the line of sight at instead of detector [Ro,Zo]
	r_ap		FLT	of the R value to translate the pos vector to to start the tracing.
	exp_rho:	FLT	of the scaling past the last rho point to include in the last bin DEFAULT: 1.85*n_rho
	kdebug:		INT	channel number to stop the voxel filling code at for debugging DEFAULT: OFF
	m:		INT	of the poloidal m number of the sine/cosine weighting matrix (if selected) DEFAULT: 1
	tree:		STRING	of the EFIT tree to use for calculating weighting matrix [DEFAULT: 'analysis']

KEYWORD PARAMETERS:
	debug:		/debug stops the function before the RETURN statement
	sine:		/sine multiples each voxel weighting by sine (using (R,Z) pt and magnetic axis at time point)
	cosine:		/cosine multiples each voxel weighting by cosine (using (R,Z) pt and magnetic axis at time point)

OUTPUTS
	result:		FLTARR [n_ch, n_rho, n_time,2] of the voxel weightings for each channel at each rho to be used in profile inversion
				at each time point.  [*,*,*,0] are for the w inversion while [*,*,*,1] are for the u profile.

OPTIONAL OUTPUTS:
	rho_vec:	FLTARR if set to an unnamed variable it will be filled with the rho vector used if it is not input through rho_vec.
	rhopts:		FLTARR [n_ch*n_s,n_time] of the rho values for all the channels along the lines of sight for each time
				slice.  This output is tied to a specific pos,tpts and n_sinput and is useful for iterating on rho_vec.
	br:		FLTARR [n_ch*n_s,n_time] of the radial B-field along the line of sight for each time slice
	bz:		FLTARR [n_ch*n_s,n_time] of the vertical B-field along the line of sight for each time slice


MODFICATION HISTORY:
	Written by:	ML Reinke 8/13/10 (Adapted from GENPOS_POS2VOXEL_MATRIX and GENSPEC_GPV2VOXEL_VEL_MATRIX)
	4/4/11		ML Reinke - added ability to get arb. m cosine/sine velvoxel matrices
	4/5/11		ML Reinke - noticed an error in the l_hat_r term, also realized that this lhat
                                   parameterization will NOT work for RT > Rmin where l_hat_r changes sign
	6-13-11:	ML Reinke - added the tree optional input for use with EFIT_RZ2XXX codes.	

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_ROCKING_MAP">
<H2>GENSPEC_ROCKING_MAP</H2></A>
<A HREF="#GENSPEC_POS2VOXEL_VEL_MATRIX">[Previous Routine]</A>
<A HREF="#GENSPEC_SHELLINVERT">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_ROCKING_MAP

PURPOSE:
	This function calculates the deposition on the detector plane for a finite rocking curve width.  This
	can then be multiplied by the line-integrated brightness

CALLING SEQUENCE
	result=GENSPEC_ROCKING_MAP(xyz_m,xyz_b,xyz_det,sig_r,int_r)

INPUTS:
	xyz_m	FLTARR	[3] of the <x,y,z> vector in the mirror coordinates of the submirror element
	xyz_b	FLTARR	[3] of the <x,y,z> vector of the central ray that defines the bragg angle
	xyz_det	FLTARR	[3,ndet] of the <x,y,z> positions of the pixels
	sig_r	FLT	of the rocking curve width [arcsec]
	
OUTPUTS:
	result	FLTARR	[ndet] of the power deposition fraction over the variety of pixels

OPTIONAL OUTPUTS:
	dth	FLTARR	[ndet] of the angular deviation of the ray from the primary ray

PROCEDURE:
	From the three points given (m,b,det) the angular deviation of the ray is found using law of cosines.
	The falloff is assumed to be gaussian w/r/t the angular deviation and controlled by the rocking
	curve width, sig_r.  This is normalized so that the total power to the detector is constant as sig_r is varied.

	DO NOT USE IF SIG_R=0.  Check beforehand and just define your own map.

MODIFICATION HISTORY:
	Written by:	M.L. Reinke 8/20/10

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec_sphere.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_SHELLINVERT">
<H2>GENSPEC_SHELLINVERT</H2></A>
<A HREF="#GENSPEC_ROCKING_MAP">[Previous Routine]</A>
<A HREF="#GENSPEC_SPHERE_IMAGE">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_SHELLINVERT

PURPOSE;
	This is an upper level function that takes spectral moments and geometry weighting information and calculates
	emissivity, velocity and ion temperatures for a given impurity using a shell inversion technique.

CALLING SEQUENCE:
	result=GENSPEC_SHELLINVERT(moments,pos,shot,time,lam_o,z)

INPUTS:
	moments:	FLTARR 	[3, n_ch, n_time] of the spectral moments
			       	[0, *, *] is the zeroth moment [photons/s/m^2/str] or other "brightness" unit
			       	[1, *, *] is the first moment  [angstroms*"bright"] consistent units with lam_o  ***will get altered***
			       	[2, *, *] is the first moment  [angstroms^2*"bright"] consistent units with lam_o
	pos:		FLTARR 	[4,n_ch] of the POS vectors for each channel.
	shot:		LONG 	shot number
	time:		FLTARR 	[n_time] of the time points.  Note that all geometry info will be calculated at EFIT time points
				and linearly interpolated between them
	lam_o:		FLT	the unshifted wavelength of the line.  Units consistent with how the moments are calculated.
	z:		INT	the z of the element that's being observed

OPTIONAL INPUTS:
	good:		INTARR	[n_ch] with 1's (use) or 0's (do not use) indicating which channels to use during the inversion
	npts:		INT	number of points to be used in SHELLINVERT DEFAULT: 25
	redge:		FLT	edge of the emissivity in major radius (will be adjusted for shell inversion) DEFAULT: calculated for outermost choord
	eps_em:		FLT	emissivity profile smoothing factor. DEFAULT: 0.1
	eps_w:		FLT	toroidal rotation profile smoothing factor. DEFAULT: 0.1
	eps_u:		FLT	field aligned rotation profile smoothing factor. DEFAULT: 0.1
	eps_ti:		FLT	ion temperature profile smoothing factor. DEFAULT: 0.1
	posrev:		INTARR	[n_ch] of 0's and 1's indicating whether or not the POS has been reveresed (for velocity information)

KEYWORD PARAMETERS:
	solidbody:	/solidbody does the first moment inversion forcing the u-profile = 0
	parallel:	/parallel does the first moment inversion forcing the w-profile = 0
	debug:		/debug stops the code in various places and just before the RETURN statement
	quiet:		/quiet suppresses terminal messages displaying computation times of various procedures

OUTPUTS:
	result:		STRUC	containing the kinetic profiles and their moment profile checks
			*.r		FLTARR 	[npts,n_time] of the midplane major radius values [m]
			*.time		FLTARR 	[n_time] of the time points (copy of time input for convience)
			*.emiss 	FLTARR 	[npts, n_time] of the line emissivities [photons/s/m^3] or "power"/m^3
			*.w		FLTARR	[npts, n_time] of the "w/2pi"-profile or toroidal rotation frequency [Hz]
			*.u		FLTARR  [npts, n_time] of the u*gradPsi-profile m^2/s (divide by R to get poloidal velocity)
			*.ti		FLTARR  [npts, n_time] of the impurity ion temperature [keV]
			*.ch		INTARR 	[n_good+1] of only the GOOD channels used in the inversion plus the forced zero at redge
			*.brchk		FLTARR 	[3, n_good+1, n_time] of the moments calculated from the calculated profiles.  This can be
						be used to check the quality of the output versus the input data.
			*.rt		FLTARR	[n_ch,n_time] of the tangency radii [m] (time evolving for /parallel only)

PROCEDURE:
	This program calculates the spatial weighting matrices using CALC_GEOM in SHELLINVERT.PRO and then
	inverts them using SHELLINVERT.  For a poloidal view, the "tangency radii" are calculated from the POS vector using
	GENPOS_POLOIDALPOS2RT while for toroidal views, the tangency radii are in the POS vector.

	The first moment profile will be altered so that it can be compared with the BRCHK.  See Section 7.1 in General Radiometry

RESTRICTIONS:
	Use GENIE_INI.bat to compile the GENPOS and GENSPEC functions in the correct order.  This also requires SHELLINVERT.

MODFICATION HISTORY:
	Written by:	ML Reinke - 2/22/08 - form adapted from GENSPEC_MATRIX_INVERT

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_SPHERE_IMAGE">
<H2>GENSPEC_SPHERE_IMAGE</H2></A>
<A HREF="#GENSPEC_SHELLINVERT">[Previous Routine]</A>
<A HREF="#GENSPEC_SPHERE_OBSEMISS">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_SPHERE_IMAGE

PURPOSE:
	This function does the raytracing for a spherical reflector, w/ finite size and rocking curve,
	through the plasma to create synthetic spectral images for testing of analysis and instrumental effects

CALLING SEQUENCE:
	result=GENSPEC_SPHERE_IMAGE(info,shot,time,lam_o,z,emiss,w,u,ti,rho)

INPUTS:
	info	STRUC	stucture of an spherical info file (see GENPOS_SPHERICAL_INFO)
	shot	LONG	shot number to use for EFIT map
	time	FLT	time point to use in shot for EFIT map
	lam_o	FLTARR	[nlines] of line centers to include in the spectra
	z	INTARR	[nlines] of the atomic number of the transitions
	emiss	FLTARR	[nrho,nlines] of the emissivity profile for each line
	w	FLTARR	[nrho] of the toroidal rotation frequency [kHz]
	u	FLTARR	[nrho] of the poloidal rotation flux function (vp=u*Bp) [km/s/T]
	ti	FLTARR	[nrho] of the ion temperature [keV]
	rho	FLTARR	[nrho] of the rho values for the above profiles (actually PSINORM)

OPTIONAL INPUTS:
	n_s	INT	number of points in the plasma to use to calculate the observed emissivity DEFAULT: 100
	n_y	INT	number of mirror bins in the y-direction DEFAULT: 5
	n_z	INT	number of mirror bins in the z-direction DEFAULT: 5
	rzbnd	FLTARR	[3] of the [rmin,rmax,abs(z)] in [m] of the rectangular bin to terminate ray tracing DEFAULT: [0.44,1.0,0.45]
	r_ap	FLT	of the major radius [m] to translate the POS vector to DEFAULT: not used, ray starts at (R,Z)=(pos[0],pos[1])
	z_ap	FLT	of the height [m] to translate the POS vector to DEFAULT: not used, ray starts at (R,Z)=(pos[0],pos[1])

KEYWORD PARAMETERS:
	/verb turns on messages to the terminal
	/uposload will load the UPOS data from a save file to increase speed for multiple calls
	
PROCEDURE:
	This function operates on similar principles as LINE_BR, defining the emissivity along a line of sight and then integrating along the
	path to get the brightness.  The observed emissivity profiles is calculated for each pixel/mirror combination using the Bragg angle
	to select the wavelength.  This can be deposited over multiple pixels using the map from GENSPEC_ROCKING_MAP.
	
	A loop is done over the detector points defined by the INFO file and the impact on the image is saved after each pixel is traced over
	all mirror elements so that the image can be viewed prior to completion due to the long run times for large numbers of
	pixels.

RESTRICTIONS:
	This program will save data in your home directory at /idl/hirexsr/genspec/ so that file must be created otherwise things will crash.
	The username is autodetected using LOGNAME in MLR_FUNCTIONS.

MODIFICATION HISTORY:
	Written by:	M.L. Reinke - 8/22/10

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec_sphere.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_SPHERE_OBSEMISS">
<H2>GENSPEC_SPHERE_OBSEMISS</H2></A>
<A HREF="#GENSPEC_SPHERE_IMAGE">[Previous Routine]</A>
<A HREF="#GENSPEC_SUB_VECTOR">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_SPHERE_OBSEMISS

PURPOSE:
	This function calculates the "observed" emissivity profile for a Bragg reflector along a line of sight through the plasma

CALLING SEQUENCE:
	result=GENSPEC_SPHERE_OBSEMISS(lam_b,lam_o,em,vel,wid,lhat)

INPUTS:
	lam_b	FLT	the wavelength that satisfies the Bragg equation [Ang]
	lam_o	FLTARR	[nlines] of the unshifted line centers for the spectrum of interest
	em	FLTARR	[ns,nlines] of the emissivity for each line along the line of sight [AU]
	vel	FLTARR	[ns,3] of the velocity [v_R, v_phi,v_Z] along the line of sight[m/s]
	ti	FLTARR	[ns] of the line width along the line of sight [keV]
	lhat	FLTARR	[ns,3] of the unit vector [R,phi,Z] along the line of sight
	
OUTPUTS:
	result	FLTARR	[ns] of the observed emissivity along the line of sight [AU]

PROCEDURE:
	This function calculates the Doppler line shape at each spatial point in the plasma along the line of sight and 


MODIFICATION HISTORY:
	Written by:	M.L. Reinke - 8/20/10
	M.L. Reinke	8/22/10 - modified to properly include the Rocking curve effect and use temperature rather than width
	M.L. Reinke	8/23/10 - modified to asssume the ti/vel are the same for all lines (for now)

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec_sphere.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_SUB_VECTOR">
<H2>GENSPEC_SUB_VECTOR</H2></A>
<A HREF="#GENSPEC_SPHERE_OBSEMISS">[Previous Routine]</A>
<A HREF="#GENSPEC_VEL_COEF_MATRIX">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_SUB_VECTOR

PURPOSE:
	This function generates the vector to be subtracted from the 2nd moment vector in the inversion of
	a Doppler spectra.  Data from the emissivity and velocity inversion are necessary to generate the output.

CALLING SEQUENCE:
	result=GENSPEC_SUB_VECTOR(gpv,pos,line,rhopts,ves_grid,coefs_0,order_0,coefs_1,order_1)

INPUTS:
	gpv:		FLTARR	n x m where n is the number of channels and m is the number of pixels.  These are the volume coefficents
				generated using GENPOS_VOL_COEFS [meters^3]
	pos:		FLTARR 	4 x n of the central (or weighted) POS vector for each channel.
	bfield:		STRUC   of data describing the magnetic field on the grid (See GENPOS_GRID_BFIELD for method)
			*.br		FLTARR [n_grid, n_time] radial component of the magnetic field [T]
			*.bphi 		FLTARR [n_grid, n_time] toroidal component of the magnetic field [T]
			*.bz		FLTARR [n_grid, n_time] veritical component of the magnetic field [T]
			*.psi_norm	FLTARR [n_grid, n_time] normalized psi values ***not used***
			*.t_pts		FLTARR [n_time] time points [s] ***not used***
			*.shot		LONG shot number ***not used***
	line:		STRUC 	containing information about the line to be calculated
			*.lam_o		FLT the rest wavelength of the line [units set wavelength scale]        
			*.del_lam	FLT used in the  wavelength interval [lam_o-del_lam, lam_o+del_lam]    ***not used***
			*.mass		FLT the mass of ion in AMU (see READ_ATOMIC_MASS('XX')
	rhopts:		FLTARR	m x t where t is the number of time points.  These are normalized radius (rho) values that correspond 
				to the m pixels and should be generated using GENPOS_GRID2RMID.
	ves_grid:	STRUC	the vessel grid generated from GENPOS_GRID using /center
	coefs_0:	FLTARR	of size order_0 x t of the emissivity expansion coefficents
	order_0:	INT	order of the emissivity expansion
	coefs_1:	FLTARR	of size order_1 x t of the velocity expansion coefficents 
	order_1:	INT	order of the velocity expansion

KEYWORD PARAMETERS:
	debug:		/debug stops the code before the RETURN statement
	bessel:		/bessel uses an orthogonal bessel expansion (see GENPOS_COEFS2PROFILE for specifics)
	solidbody:	/solidbody will generate a sub vector using only w(rho) which is pure toroidal rotation

OUTPUTS:
	result:		FLTARR of size n x t.  This data must be subtracted from the 2nd moment vector to adjust for
			velocity effects on the 2nd momemnt prior to solving the matrix equation for Ti.  Specifics are 
			(or will be soon) in 'General Equations for Radiometry in Tokamak Plasmas'

MODIFICATION HISTORY:
	Written by:	ML Reinke: 8-21-06
	6-7-07:		ML Reinke - adjusted program to use incompressible velocity togenerate the subtraction vector.
                                   also made all totals sum over points where gpv > 0 and rhopts > 0

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="GENSPEC_VEL_COEF_MATRIX">
<H2>GENSPEC_VEL_COEF_MATRIX</H2></A>
<A HREF="#GENSPEC_SUB_VECTOR">[Previous Routine]</A>
<A HREF="#XCIS_LINESHAPE">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	GENSPEC_VEL_COEF_MATRIX

PURPOSE:
	This function generates the coefficent matrix used to invert the v*em profile.  The velocity is assumed to
	be purely toroidal and a flux function.  The radial profile is expanded using polynomials or orthogonal bessel functions.

CALLING SEQUENCE:
	result=GENSPEC_VEL_COEF_MATRIX(gpv,pos,line,rhopts,ves_grid,order)

INPUTS:
	gpv:		FLTARR	n x m where n is the number of channels and m is the number of pixels.  These are the volume coefficents
				generated using GENPOS_VOL_COEFS [meters^3]
	pos:		FLTARR 	4 x n of the central (or weighted) POS vector for each channels.
	bfield:		STRUC   of data describing the magnetic field on the grid (See GENPOS_GRID_BFIELD for method)
			*.br		FLTARR [n_grid, n_time] radial component of the magnetic field [T]
			*.bphi 		FLTARR [n_grid, n_time] toroidal component of the magnetic field [T]
			*.bz		FLTARR [n_grid, n_time] veritical component of the magnetic field [T]
			*.psi_norm	FLTARR [n_grid, n_time] normalized psi values ***not used***
			*.t_pts		FLTARR [n_time] time points [s] ***not used***
			*.shot		LONG shot number ***not used***
	line:		STRUC 	containing information about the line to be calculated
			*.lam_o		FLT the rest wavelength of the line [units set wavelength scale]        
			*.del_lam	FLT used in the  wavelength interval [lam_o-del_lam, lam_o+del_lam]    ***not used***
			*.mass		FLT the mass of ion in AMU (see READ_ATOMIC_MASS('XX')
	rhopts:		FLTARR	m x t where t is the number of time points.  These are normalized radius (rho) values that correspond 
				to the m pixels and should be generated using GENPOS_GRID2RMID.
	ves_grid:	STRUC	the vessel grid generated from GENPOS_GRID using /center
	order:		INT	order of the expansion (see PROCEDURE for details)

KEYWORD PARAMETERS:
	bessel:		/bessel will use an orthogonal bessel function expansion instead of polynomials
	solidbody:	/solidbody will generate a coef matrix using only w(rho) which is pure toroidal rotation

OUTPUTS:
	result:		FLTARR n x order x t where [*,*,i] is the matrix, A, to be used in the least squares inversion of (A*x=b) where
			b is the vector of length n and x is the vector of length order and are the coeffcients of the
			See http://en.wikipedia.org/wiki/Linear_least_squares for a brief overview and Numerical Recipes for
			something more indepth.

PROCEDUE:
	There will be a note in 'General Equations for Radiometry in Tokamak Plasmas' regarding how the expansion works but
	for now just talk to ML Reinke directly if you've got questions on the method.

MODIFICATION HISTORY:
	Written by:	ML Reinke: 8-21-06
	6-7-08:	 	ML Reinke - modified to use u(rho) w(rho) and added solidbody keyword to just use w(rho)
				    Also changed the WHERE that total is taken over to be both the non-zero values of GPV and rhopts
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
<A NAME="XCIS_LINESHAPE">
<H2>XCIS_LINESHAPE</H2></A>
<A HREF="#GENSPEC_VEL_COEF_MATRIX">[Previous Routine]</A>
<A HREF="#_GENSPEC">[Next Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	XCIS_LINESHAPE

</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec_sphere.pro)</STRONG><P>
<HR>
 
<A NAME="_GENSPEC">
<H2>_GENSPEC</H2></A>
<A HREF="#XCIS_LINESHAPE">[Previous Routine]</A>
<A HREF="#ROUTINELIST">[List of Routines]</A>
<PRE>
NAME:
	_GENSPEC

PURPOSE:
	The GENSPEC_* suite of procedures and functions are the
	application of formulas and methods in 'General Equations for
	Radiometry in Tokamak Plasmas' for spectral emissivity.  There
	is a substantial draw on the lower level upon GENPOS codes.

	Version 0.5 - testing of inversions
	Version 0.9 - updated to use incompressibility in velocity (06/07)
	Version 1.0 - added the ability to use a matrix inversion
                     technique (07/07)	
	Version 1.1 - upgraded GENSPEC_GPV2SPECTRA to use new input
                     formats and multiple lines.  Added the ability
                     to determine the u-profile and use edge zeros in
                     GENSPEC_MATRIX_INVERT (08/07)
	Version 1.2 - various tweaks and the addition of
                     GENSPEC_SHELLINVERT
.
MODIFICATION HISTORY:
	Version 1.2
	ML Reinke 
	February 22nd, 2008
</PRE><P>
<STRONG>(See /usr/local/cmod/idl/GENIE/GENSPEC/genspec.pro)</STRONG><P>
<HR>
 
</body>
</html>

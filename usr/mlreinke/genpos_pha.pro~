FUNCTION pha_pos,u=u,info=info,theta=theta,load=load
	savepath='/usr/local/cmod/codes/spectroscopy/pha/pha_pos.sav'
	IF NOT keyword_set(load) THEN BEGIN
		path='/home/mlreinke/GENIE/usr/mlreinke/pilatus_pha.info
		info=genpos_planar_info(path)
		IF keyword_set(theta) THEN info.ap.rot[1]=theta*!pi/180.0
		pos=genpos_planar2pos(info,etendue=u)
		save,pos,u,info,filename=savepath
	ENDIF ELSE restore, savepath
	RETURN, pos
END

FUNCTION load_pha_pos,etendue=etendue,xch=xch
	ipos=pha_pos(u=iu,/load)
	IF NOT keyword_set(xch) THEN xch=13
	pixels=findgen(487/xch)*195*xch+195/2	;every x pixels along the center
	pos=ipos[*,pixels]
	genpos_pos_reform,pos,[0.4,1.0,-0.8,0.8]
	tmp=where(pos[1,*] LT 0.3)	;rough filter to remove upper channels
	etendue=iu[pixels]
	pos=pos[*,tmp]
	etendue=etendue[tmp]
	RETURN,pos
END

PRO show_genpos_pha,shot=shot,time=time,eps=eps,sigma=sigma,flat=flat,xch=xch
	IF NOT keyword_set(shot) THEN shot=1140815012
	IF NOT keyword_set(time) THEN time=1.0
	IF NOT keyword_set(eps) THEN eps=1.0
	IF NOT keyword_set(sigma) THEN sigma=0.0
	
	efit_time=line_gettimes(shot)
	efit_rmid=line_getrmid(shot)
	efit_axis=line_getaxis(shot)
	index=ipt(efit_time,time)
        irmid=reform(efit_rmid[index,*])
        rho=(irmid-irmid[0])/(last(irmid)-irmid[0])
	IF keyword_set(flat) THEN emiss=rho*0.0+1.0 ELSE emiss=(1-rho^2)+3*exp(-(rho-0.7)^2/(2*0.2^2))*(1-rho^1.5)
	pos=load_pha_pos(etendue=u,xch=xch)
	nch=n(pos[0,*])+1
	chnum=indgen(nch)+1
	line_path_plots,pos,shot=shot,tpt=time,rzbnd=rzbnd
	br=genpos_line_br(pos,emiss,irmid,time,shot,time)
	err=randomn(seed,nch)*sigma*br
	pos[3,*]+=0.08
	br+=err
	vox=genpos_pos2voxel_matrix(pos,(fltarr(nch)+1.0)*(4.0*!pi),shot,tpts=time,rzbnd=rzbnd,n_rho=int(nch*1.5),rho_vec=rho_vec)
	eminv=genpos_profile_invert(br,vox,eps*max(vox),brchk=brchk,err=sigma*br)

	IF !d.name EQ 'PS' THEN BEGIN
		xsize=6.0
		ysize=5.0
		device, xsize=xsize, ysize=ysize, /inches
	ENDIF
	openwin,0
	ymax=max(brchk.mom) > max(br)
	plot,[0],[0],xr=[0,nch+1],yr=[0,ymax]*1.05,/xsty,/ysty,xtit='CH#',ytit='Brightness'
	oploterror,chnum,br,br*sigma,psym=8
	oplot,chnum,brchk.mom,color=30
	xyouts, 22	,1.5,'MEASURED'
	xyouts, 22,1.3,'BRCHK',color=30

	openwin,1
	ymax=max(eminv) > max(emiss)
	plot,[0],[0],xr=[0,1],yr=[0,ymax]*1.05,/xsty,/ysty,xtit='RHO',ytit='Emissivity'
	oploterror,rho_vec,eminv,brchk.inverr,color=30,errcolor=30
	oplot,rho,emiss
	xyouts, 0.05,2.0,'DEFINED'
	xyouts, 0.05,1.8,'RECONSTRUCTED',color=30

	stop
END